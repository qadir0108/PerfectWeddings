<style>
    #moduleTbl td,th{ text-align:center;}

    #moduleTbl {
    margin-top:10px;
    }

    #savePermissionBtn {
    margin-bottom:10px;
    }
</style>
<div class="row">
    <div class="col-lg-12">
    
        <div class="portlet light portlet-fit ">
            <div class="portlet-title">
                <div class="caption">
                    <i class=" icon-layers font-green"></i>
                    <span class="caption-subject font-green bold uppercase">Module Permissions</span>

                </div>
            </div>
            <div class="portlet-body">
                <div class="row">
                    <div class="col-xs-12">
                        <div class="form-group">
                            <div class="col-md-2">
                                <label class="control-label">Select Company</label>
                               
                            </div>
                            <div class="col-md-4">
                              <select class="form-control" id="compDDL"></select>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-12">
                          <table class="table table-bordered " id="moduleTbl">
                                <thead>
                                    <tr>
                                        <th> # </th>
                                        <th> Module</th>
                                        <th> Start Date</th>
                                        <th> End Date</th>
                                        <th> Grant Permission</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td> 1 </td>
                                        <td> <span class="label label-success"> Backlog </span> </td>
                                        <td><input type="text" class="form-control StartDate" id="backlogStartDate" readonly="readonly" /></td>
                                        <td><input type="text" class="form-control EndDate" id="backlogEndDate" readonly="readonly" /></td>
                                        <td> <input type="checkbox"  id="backlogCheckBox" value="@PerfectWeddings.Enums.Modules.Backlog" />  </td>
                                       
                                    </tr>
                                    <tr>
                                        <td> 2 </td>
                                        <td> <span class="label  label-info"> TaskBoard </span> </td>
                                        <td><input type="text" class="form-control StartDate" id="taskBoardStartDate" readonly="readonly" /></td>
                                        <td><input type="text" class="form-control EndDate" id="taskBoardEndDate" readonly="readonly" /></td>
                                        <td> <input type="checkbox" id="taskBoardCheckBox" value="@PerfectWeddings.Enums.Modules.TaskBoard" />  </td>

                                    </tr>
                                    <tr>
                                        <td> 3 </td>
                                        <td> <span class="label  label-warning"> Capacity </span> </td>
                                        <td><input type="text" class="form-control StartDate" id="capacityStartDate" readonly="readonly" /></td>
                                        <td><input type="text" class="form-control EndDate" id="capacityEndDate" readonly="readonly" /></td>
                                        <td> <input type="checkbox"  id="capacityCheckBox" value="@PerfectWeddings.Enums.Modules.Capacity" />  </td>

                                    </tr>
                                    <tr>
                                        <td> 4 </td>
                                        <td> <span class="label  label-danger"> Execute Functional </span> </td>
                                        <td><input type="text" class="form-control StartDate" id="exeFuncStartDate" readonly="readonly" /></td>
                                        <td><input type="text" class="form-control EndDate" id="exeFuncEndDate" readonly="readonly" /></td>
                                        <td> <input type="checkbox" id="exeFuncCheckBox" value="@PerfectWeddings.Enums.Modules.ExecuteFunctional" />  </td>

                                    </tr>
                                    <tr>
                                        <td> 5 </td>
                                        <td> <span class="label label-info"> Portfolio </span> </td>
                                        <td><input type="text" class="form-control StartDate" id="portfolioStartDate" readonly="readonly" /></td>
                                        <td><input type="text" class="form-control EndDate" id="portfolioEndDate" readonly="readonly" /></td>
                                        <td> <input type="checkbox"  id="portfolioCheckBox" value="@PerfectWeddings.Enums.Modules.Portfolio" />  </td>

                                    </tr>
                                    <tr>
                                        <td> 6 </td>
                                        <td> <span class="label label-default"> Support </span> </td>
                                        <td><input type="text" class="form-control StartDate" id="supportStartDate" readonly="readonly" /></td>
                                        <td><input type="text" class="form-control EndDate" id="supportEndDate" readonly="readonly" /></td>
                                        <td> <input type="checkbox"   id="supportCheckBox" value="@PerfectWeddings.Enums.Modules.Support" />  </td>

                                    </tr>
                                    <tr>
                                        <td> 7 </td>
                                        <td> <span class="label" style="background-color:#32C5D2;"> Test Cases </span> </td>
                                        <td><input type="text" class="form-control StartDate" id="testcaseStartDate" readonly="readonly" /></td>
                                        <td><input type="text" class="form-control EndDate" id="testcaseEndDate" readonly="readonly" /></td>
                                        <td> <input type="checkbox"  id="testcaseCheckBox" value="@PerfectWeddings.Enums.Modules.TestCases" />  </td>

                                    </tr>
                                    <tr>
                                        <td> 8 </td>
                                        <td> <span class="label" style="background-color:#8E44AD;"> User Stories </span> </td>
                                        <td><input type="text" class="form-control StartDate" id="userstoryStartDate" readonly="readonly" /></td>
                                        <td><input type="text" class="form-control EndDate" id="userstoryEndDate" readonly="readonly" /></td>
                                        <td> <input type="checkbox" id="userstoryCheckBox" value="@PerfectWeddings.Enums.Modules.UserStories" />  </td>
                                    </tr>

                                    <tr>
                                        <td> 9 </td>
                                        <td> <span class="label" style="background-color:#C8D046;"> Defect </span> </td>
                                        <td><input type="text" class="form-control StartDate" id="defectStartDate" readonly="readonly" /></td>
                                        <td><input type="text" class="form-control EndDate" id="defectEndDate" readonly="readonly" /></td>
                                        <td> <input type="checkbox"  id="defectCheckBox" value="@PerfectWeddings.Enums.Modules.Defects" />  </td>
                                    </tr>
                                </tbody>
                            </table>
                        
                        <input type="button" id="savePermissionBtn" class="btn btn-primary  pull-right" value="Save" />
                    </div>
                   
                </div>
            </div>
        </div>
    </div>

</div>
@Scripts.Render("~/bundles/jquery")
<script>

    $(document).ready(function () {


        $(".StartDate").datepicker({
            autoclose: true,
            format: "mm-dd-yyyy"
        });

        $(".EndDate").datepicker({
            autoclose: true,
            format: "mm-dd-yyyy"
        });

        getAllCompany();

        function getAllCompany() {
            $.ajax({
                type: 'GET',
                url: "/UserManagement/GetAllCompanies",
                contentType: 'application/json',
                success: function (data) {
                    $("#compDDL").empty();
                    var html = "<option value=0>Select</option>";
                    $("#compDDL").append(html);
                    $.each(data, function (i) {
                        var html = '<option value="' + data[i].ID + '">' + data[i].Name + '</option>';
                        $("#compDDL").append(html);
                    });
                }
            });
        }


        $("#savePermissionBtn").on("click", function () {

            var ModulesValidation = false;

            var TempItems = [];
            var CompanyValue = $("#compDDL").val();

            if (CompanyValue == 0) {
               showToaster({ msg: "Please select Company", priority: "warning" });
            }

            else {

                $('#moduleTbl').find('input[type="checkbox"]:checked').each(function () {
                  
                    var moduleType = $(this).val();
                    var sDate = $(this).closest('tr').find('.StartDate').val();
                    var eDate = $(this).closest('tr').find('.EndDate').val();


                    if ((sDate != "" && eDate != "") && (eDate >= sDate)) {

                        TempItems.push({
                            Module: moduleType,
                            StartDate: sDate,
                            EndDate: eDate
                        });

                        ModulesValidation = true;
                    }

                    else {
                        ModulesValidation = false;

                        return false;
                    }
                });



                if (ModulesValidation) {

                    if (TempItems.length > 0) {
                        things = JSON.stringify({ CompanyID: CompanyValue, 'Details': TempItems });

                        $.ajax({
                            contentType: 'application/json; charset=utf-8',
                            dataType: 'json',
                            type: 'POST',
                            url: '/UserManagement/SaveModulePermission',
                            traditional: true,
                            data: things,
                            success: function () {

                                showToaster({ msg: "Record Saved", priority: "success" });

                                clearSelection();

                            },
                            failure: function () {
                            }
                        });
                    }
                }

                else {

                    showToaster({ msg: "Please enter values correctly", priority: "warning" });
                }
            }

        });

        function clearSelection()
        {
            $("#compDDL").prop('selectedIndex', 0);
            $(".StartDate").val('');
            $(".EndDate").val('');

            $('#moduleTbl').find('input[type="checkbox"]:checked').each(function () {
                $(this).prop('checked', false);
            });

        }
        function parseJsonDate(jsonDateString) {
            var jsonDate = new Date(parseInt(jsonDateString.replace('/Date(', '')));
            var FormattedDate = (jsonDate.getMonth() + 1) + '-' + jsonDate.getDate() + '-' + jsonDate.getFullYear()
            return FormattedDate;
        }


        $("#compDDL").on("change", function () {

            $("input[type=checkbox]").prop("checked", false);

            $(".StartDate").val('');
            $(".EndDate").val('');


            var CompanyValue = $("#compDDL").val();

            if (CompanyValue == 0) {
              //  showToaster({ msg: "Please select Company", priority: "warning" });
            }

            else {

                $.ajax({
                    contentType: 'application/json',
                    dataType: 'json',
                    type: 'GET',
                    url: '/UserManagement/GetModulePermissionByCompany',
                    data: { CompanyID: CompanyValue },
                    success: function (data) {
                      
                        $.each(data, function (i) {

                            var formatStartDate = parseJsonDate(data[i].StartDate);

                            var formateEndDate = parseJsonDate(data[i].EndDate); 

                            if (data[i].Module == "Backlog")
                            {
                               
                                $("#backlogStartDate").val(formatStartDate);
                                $("#backlogEndDate").val(formateEndDate);
                                $("#backlogCheckBox").prop('checked', true);
                            }

                            else if (data[i].Module == "TaskBoard") {

                                $("#taskBoardStartDate").val(formatStartDate);
                                $("#taskBoardEndDate").val(formateEndDate);
                                $("#taskBoardCheckBox").prop('checked', true);
                            }

                            else if (data[i].Module == "TestCases") {

                                $("#testcaseStartDate").val(formatStartDate);
                                $("#testcaseEndDate").val(formateEndDate);
                                $("#testcaseCheckBox").prop('checked', true);
                            }

                            else if (data[i].Module == "UserStories") {

                                $("#userstoryStartDate").val(formatStartDate);
                                $("#userstoryEndDate").val(formateEndDate);
                                $("#userstoryCheckBox").prop('checked', true);
                            }

                            else if (data[i].Module == "Capacity") {

                                $("#capacityStartDate").val(formatStartDate);
                                $("#capacityEndDate").val(formateEndDate);
                                $("#capacityCheckBox").prop('checked', true);
                            }

                            else if (data[i].Module == "Portfolio") {

                                $("#portfolioStartDate").val(formatStartDate);
                                $("#portfolioEndDate").val(formateEndDate);
                                $("#portfolioCheckBox").prop('checked', true);
                            }

                            else if (data[i].Module == "ExecuteFunctional") {

                                $("#exeFuncStartDate").val(formatStartDate);
                                $("#exeFuncEndDate").val(formateEndDate);
                                $("#exeFuncCheckBox").prop('checked', true);
                            }

                            else if (data[i].Module == "Defects") {

                                $("#defectStartDate").val(formatStartDate);
                                $("#defectEndDate").val(formateEndDate);
                                $("#defectCheckBox").prop('checked', true);
                            }

                            else if (data[i].Module == "Support") {

                                $("#supportStartDate").val(formatStartDate);
                                $("#supportEndDate").val(formateEndDate);
                                $("#supportCheckBox").prop('checked', true);
                            }
                        });

                    },
                    failure: function () {
                    }
                });

            }
        });
    });
</script>